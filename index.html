<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŠ æœªçŸ¥æµ·åŸŸ Â· ç¦èˆªå€</title>
    <!-- å­—é«”å¼•å…¥ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Cinzel:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-deep: #071A2B;
            --ocean-blue: #0B2D4A;
            --moonlight: #7CD6FF;
            --gold: #F7D77A;
            --pink-purple: #C9A7FF;
            --text-main: #EAF6FF;
            --text-sub: rgba(234,246,255,0.75);
            --err-red: #FF6B6B;
            --card-bg: rgba(7, 26, 43, 0.8);
            --ocean-gradient: linear-gradient(180deg, #071A2B 0%, #0B2D4A 100%);
        }

        body {
            background-color: var(--bg-deep);
            background: var(--ocean-gradient);
            color: var(--text-main);
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0; overflow: hidden; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            transition: background 1.5s ease;
        }

        /* --------------------------------------------------
           è±ªè¯æµ·æ´‹å‹•ç•«ç³»çµ± (Advanced Ocean FX)
           -------------------------------------------------- */
        #fx-layer { position: fixed; inset: 0; z-index: 2; pointer-events: none; }
        
        /* 1. å‹•æ…‹æµ·æµª */
        .waves { position: fixed; bottom: 0; left: 0; width: 100%; height: 15vh; min-height: 100px; max-height: 150px; z-index: 1; opacity: 0.5; transition: 1s; }
        .parallax > use { animation: move-forever 25s cubic-bezier(.55,.5,.45,.5) infinite; }
        .parallax > use:nth-child(1) { animation-delay: -2s; animation-duration: 7s; }
        .parallax > use:nth-child(2) { animation-delay: -3s; animation-duration: 10s; }
        .parallax > use:nth-child(3) { animation-delay: -4s; animation-duration: 13s; }
        .parallax > use:nth-child(4) { animation-delay: -5s; animation-duration: 20s; }
        @keyframes move-forever { 0% { transform: translate3d(-90px,0,0); } 100% { transform: translate3d(85px,0,0); } }

        /* 2. èƒŒæ™¯ç”Ÿç‰© (é­šç¾¤) */
        .sea-creature { position: absolute; opacity: 0.1; pointer-events: none; filter: blur(1px); animation: swim linear infinite; }
        @keyframes swim { from { left: -150px; } to { left: 110vw; } }

        /* 3. é¢¨æš´ç‰¹æ•ˆ (Scene 5 Task 3) */
        .storm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; transition: 0.5s; z-index: 5; pointer-events: none; }
        .lightning { position: fixed; inset: 0; background: white; opacity: 0; z-index: 50; pointer-events: none; }
        .rain { position: absolute; background: rgba(255,255,255,0.2); width: 1px; height: 30px; animation: rain-fall linear infinite; }
        @keyframes rain-fall { to { transform: translateY(110vh); } }

        /* 4. éŠæˆ²åŒ–é€šé—œç‰¹æ•ˆ */
        .clear-banner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5); color: var(--gold); font-family: 'Cinzel'; font-size: 4rem; font-weight: bold; opacity: 0; z-index: 100; pointer-events: none; text-shadow: 0 0 20px var(--gold); }
        .banner-active { animation: banner-pop 1.2s forwards; }
        @keyframes banner-pop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 30% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } 70% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }

        /* --------------------------------------------------
           UI çµ„ä»¶ (RPG Style)
           -------------------------------------------------- */
        .glass-card {
            background: var(--card-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(124, 214, 255, 0.4); border-radius: 30px;
            padding: 2.5rem; width: 90%; max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); position: relative; z-index: 10;
        }

        .title-font { font-family: 'Cinzel', serif; letter-spacing: 0.2em; text-shadow: 0 0 15px var(--moonlight); }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .btn-game {
            border: 2px solid var(--moonlight); color: var(--moonlight);
            padding: 0.8rem 2.5rem; border-radius: 12px; transition: 0.4s;
            cursor: pointer; font-weight: bold; text-transform: uppercase;
            position: relative; overflow: hidden;
        }
        .btn-game:hover { background: var(--moonlight); color: var(--bg-deep); box-shadow: 0 0 35px var(--moonlight); transform: translateY(-3px); }
        .btn-game:active { transform: translateY(1px); }

        .input-game {
            background: rgba(0,0,0,0.35); border: 1px solid rgba(124, 214, 255, 0.3);
            border-radius: 10px; text-align: center; width: 100%; padding: 1.1rem;
            outline: none; color: var(--gold); font-size: 1.6rem; margin: 1.5rem 0;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
        }

        /* è²“å’ªæ´»æ½‘å°è©±æ¡† */
        .cat-dialogue {
            position: relative; background: #fff; color: #071A2B;
            padding: 12px 16px; border-radius: 18px; font-size: 0.85rem;
            margin-bottom: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            min-height: 55px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-weight: 500;
        }
        .cat-dialogue::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            border-width: 10px 10px 0; border-style: solid; border-color: #fff transparent transparent;
        }

        .dessert-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; margin: 25px 0; }
        .dessert-card { border-radius: 18px; border: 3px solid transparent; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .dessert-card img { width: 100%; height: 100%; object-fit: cover; }
        .dessert-card.selected { border-color: var(--gold); box-shadow: 0 0 30px var(--gold); transform: scale(1.08); }

        .toast {
            position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #000; padding: 14px 35px;
            border-radius: 60px; font-weight: bold; opacity: 0; z-index: 100;
            transition: 0.5s; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .scene { display: none; }
        .scene.active { display: block; animation: scene-enter 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scene-enter { from { opacity: 0; transform: scale(0.9) translateY(30px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .style-calm { --ocean-gradient: radial-gradient(circle at center, #0B2D4A 0%, #071A2B 100%); }
        .style-storm { --ocean-gradient: linear-gradient(180deg, #020408 0%, #071A2B 100%); }
        .style-dawn { --ocean-gradient: linear-gradient(180deg, #001524 0%, #1a759f 50%, #ffcfd2 100%); --card-bg: rgba(0, 0, 0, 0.5); }

        /* ================================
           Missing FX classes (å¿…è£œ)
           ================================ */

        /* æ³¡æ³¡ */
        .bubble{
          position:absolute;
          bottom:-30px;
          border:1px solid rgba(124,214,255,0.35);
          border-radius:999px;
          opacity:0.35;
          pointer-events:none;
          animation: bubble-rise linear infinite;
        }
        @keyframes bubble-rise{
          from{ transform: translateY(0); }
          to{ transform: translateY(-120vh); }
        }

        /* é‡‘ç²‰ */
        .gold-dust{
          position:absolute;
          top:-10px;
          background: rgba(247,215,122,0.9);
          border-radius:999px;
          opacity:0.8;
          pointer-events:none;
          filter: blur(0.2px);
          animation: gold-fall linear infinite;
        }
        @keyframes gold-fall{
          to{ transform: translateY(120vh); opacity:0; }
        }

        /* é–ƒé›» */
        .flash-active{ animation: flash 0.25s ease; }
        @keyframes flash{
          0%{opacity:0;}
          15%{opacity:0.9;}
          100%{opacity:0;}
        }

        /* é€šé—œæŠ–å‹• */
        .shake{ animation: shake 0.5s ease; }
        @keyframes shake{
          0%,100%{ transform: translate(0,0); }
          20%{ transform: translate(-6px, 2px); }
          40%{ transform: translate(6px, -2px); }
          60%{ transform: translate(-4px, -2px); }
          80%{ transform: translate(4px, 2px); }
        }

        /* ç¥ç¦å€æ·¡å…¥æ”¾å¤§ */
        .scale-up{ animation: scaleUp 0.9s ease forwards; }
        @keyframes scaleUp{
          from{ opacity:0; transform: scale(0.96); }
          to{ opacity:1; transform: scale(1); }
        }
    </style>
</head>
<body class="style-calm">

    <!-- èƒŒæ™¯ç‰¹æ•ˆåœ–å±¤ -->
    <div id="fx-layer"></div>
    <div id="storm-overlay" class="storm-overlay"></div>
    <div id="lightning-fx" class="lightning"></div>
    <div id="clear-banner" class="clear-banner">LEVEL CLEAR</div>
    <div id="toast-msg" class="toast"></div>

    <!-- èƒŒæ™¯æµ·æµª SVG -->
    <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" /></defs>
        <g class="parallax">
            <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(124,214,255,0.7)" />
            <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(124,214,255,0.5)" />
            <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(124,214,255,0.3)" />
            <use xlink:href="#gentle-wave" x="48" y="7" fill="rgba(124,214,255,0.2)" />
        </g>
    </svg>

    <main class="glass-card" id="game-container">
        
        <!-- Scene 0: å°é¢å…¥å£ -->
        <div id="scene-0" class="scene active text-center">
            <div class="mb-10 flex justify-center opacity-80 scale-150">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--moonlight)" stroke-width="1.2" class="animate-[spin_15s_linear_infinite]"><circle cx="12" cy="12" r="10"/><path d="m16.24 7.76-1.41 4.25-4.25 1.41 1.41-4.25 4.25-1.41Z"/><circle cx="12" cy="12" r="0.5" fill="currentColor"/></svg>
            </div>
            <h1 class="text-3xl sm:text-4xl mb-4 title-font font-bold text-[var(--moonlight)] whitespace-nowrap">  ğŸŒŠ æœªçŸ¥æµ·åŸŸ Â· ç¦èˆªå€ ğŸŒŠ</h1>
            <p class="text-sm mb-16 tracking-[0.4em] text-[var(--text-sub)]">åªæœ‰çœŸæ­£çš„æ¢éšªå®¶æ‰èƒ½é è¿‘ã€‚</p>
            <button class="btn-game" onclick="nextScene(1)">é–‹å§‹èˆªè¡Œ START</button>
        </div>

        <!-- Scene 1: å¯†ç¢¼é—œå¡ I -->
        <div id="scene-1" class="scene text-center">
            <h2 class="text-2xl mb-6 title-font text-[var(--moonlight)]">èˆªæµ·æª¢å®š I</h2>
            <p class="text-sm mb-4 opacity-80">è«‹è¼¸å…¥ç”Ÿæ—¥å››ç¢¼</p>
            <input type="password" id="pw1" class="input-game" maxlength="4" autocomplete="off">
            <div id="err1" class="text-xs text-[var(--err-red)] h-4 font-bold mb-4"></div>
            <button class="btn-game" onclick="checkPw1()">ç¢ºèªæŒ‡ä»¤</button>
        </div>

        <!-- Scene 2: å¯†ç¢¼é—œå¡ II -->
        <div id="scene-2" class="scene text-center">
            <h2 class="text-2xl mb-6 title-font text-[var(--moonlight)]">èˆªæµ·æª¢å®š II</h2>
            <p class="text-sm mb-4 opacity-80">è«‹è¼¸å…¥å°æ–¹ç”Ÿæ—¥ï¼ˆå››ç¢¼ï¼‰</p>
            <input type="password" id="pw2" class="input-game" maxlength="4" autocomplete="off">
            <div id="err2" class="text-xs text-[var(--err-red)] h-4 font-bold mb-4"></div>
            <button class="btn-game" onclick="checkPw2()">å•Ÿå‹•å…¥å£</button>
        </div>

        <!-- Scene 3: æ‰“å­—æ©Ÿæ•˜äº‹ -->
        <div id="scene-3" class="scene relative">
            <div id="typewriter-box" class="mono-font text-[0.95rem] leading-loose text-left"></div>
            <div class="text-center mt-12">
                <button id="scene3-btn" class="btn-game hidden" onclick="nextScene(4)">å¬å–šéšŠå‹ RECRUIT</button>
            </div>
        </div>

        <!-- Scene 4: è²“å’ªåŒä¼´ -->
        <div id="scene-4" class="scene">
            <h2 class="text-2xl mb-12 text-center title-font text-[var(--moonlight)]">å°ˆæ¥­æ¢éšªéšŠ</h2>
            <div class="flex justify-around items-end gap-4 mb-10">
                <div class="flex flex-col items-center w-1/2">
                    <div class="cat-dialogue" onclick="catSpeech('A')">
                        <span id="catA-msg" class="text-center">å–µï¼šæˆ‘åªæ˜¯è·¯é...</span>
                    </div>
                    <img src="./images/catA.jpg" class="w-24 h-24 rounded-full border-4 border-[var(--moonlight)] bg-slate-800 shadow-2xl cursor-pointer hover:scale-110 transition object-cover" onclick="catEgg('A')">
                    <p class="text-[0.7rem] mt-4 font-bold text-[var(--pink-purple)] tracking-widest bg-black/40 px-3 py-1 rounded">æµ·åœ–å®ˆè­·è€…</p>
                </div>
                <div class="flex flex-col items-center w-1/2">
                    <div class="cat-dialogue" onclick="catSpeech('B')">
                        <span id="catB-msg" class="text-center">å–µï¼šæˆ‘å€‘è¦å»å“ªï¼Ÿ</span>
                    </div>
                    <img src="./images/catB.jpg" class="w-24 h-24 rounded-full border-4 border-[var(--moonlight)] bg-slate-800 shadow-2xl cursor-pointer hover:scale-110 transition object-cover" onclick="catEgg('B')">
                    <p class="text-[0.7rem] mt-4 font-bold text-[var(--pink-purple)] tracking-widest bg-black/40 px-3 py-1 rounded">æµªèŠ±åµå¯Ÿå“¡</p>
                </div>
            </div>
            <div class="text-center">
                <button class="btn-game" onclick="runQuest(1)">é–‹å§‹ä»»å‹™ START MISSION</button>
            </div>
        </div>

        <!-- Scene 5: ä»»å‹™é¡Œçµ„ -->
        <div id="scene-5" class="scene">
            <div id="quest-stage" class="text-[1rem] leading-relaxed text-left"></div>
        </div>

        <!-- Final Scene: æµ·åŸŸæ ¸å¿ƒ -->
        <div id="scene-final" class="scene text-center">
            <div class="mb-8 flex justify-center scale-150">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" class="animate-pulse"><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8L12 2Z"/></svg>
            </div>
            <h2 id="final-title" class="text-2xl mb-6 title-font text-[var(--gold)] font-bold">æµ·åŸŸæ ¸å¿ƒ Â· æœªçŸ¥ä¹‹å¢ƒ</h2>
            <div id="final-narrative" class="text-[0.95rem] mb-8 leading-loose text-left"></div>
            <div id="final-ui" class="hidden">
                <p class="text-sm mb-4 opacity-80">å±¬æ–¼æˆ‘å€‘çš„ å›æ†¶ä¹‹åœ° æ˜¯ï¼Ÿ</p>
                <input type="text" id="final-ans" class="input-game" placeholder="åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ">
                <button class="btn-game" onclick="checkFinal()">æ­é–‹é¢ç´— REVEAL</button>
            </div>
        </div>

        <!-- Scene 6: çµå±€ç¥ç¦ -->
        <div id="scene-6" class="scene text-center">
            <div id="ending-narrative" class="text-[1.05rem] leading-loose mb-10 text-left"></div>
            <div id="ending-ui" class="hidden flex flex-col gap-5">
                <button class="btn-game text-xl" onclick="triggerEnding()">æˆ‘é¡˜æ„</button>
                <button id="think-btn" class="text-xs text-[var(--text-sub)] underline opacity-50" onclick="handleWait()">æˆ‘è¦å…ˆæƒ³ä¸€ä¸‹</button>
            </div>
        </div>

        <!-- Final Blessing Scene -->
        <div id="scene-blessing" class="scene text-center">
            <div id="recall-area" class="text-xl mb-12 font-bold text-[var(--moonlight)]"></div>
            <div id="blessing-area" class="hidden scale-up">
                <h1 class="text-4xl sm:text-5xl mb-10 title-font text-[var(--gold)] drop-shadow-[0_0_20px_rgba(247,215,122,0.8)] whitespace-nowrap">  ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚</h1>
                <div class="text-[1.1rem] leading-loose mb-16 space-y-6">
                    <p>é¡˜æˆ‘çš„æº«æŸ”åƒå¤§æµ·ä¸€æ¨£ï¼Œ</p>
                    <p>åœ¨ä½ éœ€è¦çš„æ™‚å€™æ“æŠ±ä½ ã€é™ªè‘—ä½ ã€‚</p>
                    <p>ç”Ÿæ—¥å¿«æ¨‚ï¼Œä¹Ÿè¬è¬ä½ é¡˜æ„é è¿‘æˆ‘ã€‚</p>
                    <span class="mt-16 block font-bold text-3xl tracking-widest text-[var(--moonlight)]">â€”â€” ä½ çš„é‚£ç‰‡æµ· JT</span>
                </div>
                <div class="flex justify-center gap-12 mt-24">
                    <span class="cursor-pointer opacity-30 hover:opacity-100 transition-all transform hover:scale-150 text-4xl" onclick="showToast('å½©è›‹ Aï¼šå¿«å»æŠ±æŠ±ä»–å§ ğŸ±')">ğŸ±</span>
                    <span class="cursor-pointer opacity-30 hover:opacity-100 transition-all transform hover:scale-150 text-4xl" onclick="showToast('å½©è›‹ Cï¼šå¦³æ˜¯æˆ‘æœ€å–œæ­¡çš„èˆªç·š âœ¨')">âœ¨</span>
                    <span class="cursor-pointer opacity-30 hover:opacity-100 transition-all transform hover:scale-150 text-4xl" onclick="showToast('å½©è›‹ Bï¼šæ„›å¦³å”· â¤ï¸')">â¤ï¸</span>
                </div>
                <button class="mt-28 text-[0.7rem] opacity-20 uppercase tracking-[0.5em] hover:opacity-100 transition" onclick="location.reload()">RE-EXPLORE THE SEA</button>
            </div>
        </div>
    </main>

    <script>
        const state = {
            chosenDessert: "",
            chosenValues: [],
            catAIdx: 0, catBIdx: 0,
            starClicks: 0,
            catAClicks: 0, catBClicks: 0
        };

        const catALines = ["å–µï¼šæˆ‘åªæ˜¯è·¯éï¼Œé †ä¾¿ç•¶ä½ çš„å‰¯éšŠé•·ã€‚", "å–µï¼šæˆ‘æœ‰ä¸€ç¨®é æ„Ÿâ€¦ä½ æœƒè¿·è·¯ã€‚", "å–µï¼šå¦‚æœæœ‰å¯¶è—ï¼Œå…ˆå¯«æˆ‘åå­—ã€‚"];
        const catBLines = ["å–µï¼šæˆ‘å€‘è¦å»å“ªï¼Ÿå¯ä»¥å…ˆåƒç½ç½å—ï¼Ÿ", "å–µï¼šæˆ‘è² è²¬å¯æ„›ï¼Œä½ è² è²¬åŠªåŠ›ã€‚", "å–µï¼šå‰æ–¹æœ‰å±éšªâ€¦ä½†æˆ‘å¿˜äº†æ˜¯å“ªè£¡ã€‚"];

        // è¦–è¦ºç‰¹æ•ˆæ§åˆ¶å™¨ (Visual FX)
        const FX = {
            spawn(type, count) {
                const layer = document.getElementById('fx-layer');
                if(type === 'clear') { layer.innerHTML = ""; return; }
                for(let i=0; i<count; i++) {
                    const el = document.createElement('div');
                    el.style.left = `${Math.random() * 100}vw`;
                    el.style.animationDelay = `${Math.random() * 5}s`;
                    if(type === 'creature') {
                        el.className = 'sea-creature';
                        el.innerHTML = `<svg width="${Math.random()*60+40}" height="40" viewBox="0 0 100 40" fill="var(--moonlight)"><path d="M0 20 C20 0, 80 0, 100 20 C80 40, 20 40, 0 20"/></svg>`;
                        el.style.top = `${Math.random() * 80}vh`;
                        el.style.animationDuration = `${Math.random() * 15 + 15}s`;
                    } else if(type === 'rain') {
                        el.className = 'rain';
                        el.style.animationDuration = `${Math.random() * 0.5 + 0.5}s`;
                    } else if(type === 'bubble') {
                        el.className = 'bubble';
                        el.style.width = el.style.height = `${Math.random()*20+5}px`;
                        el.style.animationDuration = `${Math.random()*5+5}s`;
                    } else if(type === 'gold') {
                        el.className = 'gold-dust';
                        el.style.width = el.style.height = `${Math.random()*4+1}px`;
                        el.style.animationDuration = `${Math.random()*8+4}s`;
                    }
                    layer.appendChild(el);
                }
            },
            lightning() {
                const fx = document.getElementById('lightning-fx');
                fx.classList.remove('flash-active'); void fx.offsetWidth;
                fx.classList.add('flash-active');
            },
            levelClear() {
                const b = document.getElementById('clear-banner');
                b.classList.remove('banner-active'); void b.offsetWidth;
                b.classList.add('banner-active');
                document.body.classList.add('shake');
                setTimeout(() => document.body.classList.remove('shake'), 500);
            }
        };

        function typewriter(id, lines, delay = 40, callback) {
            const target = document.getElementById(id);
            target.innerHTML = "";
            let l = 0, c = 0;
            function type() {
                if(l < lines.length) {
                    if(c < lines[l].length) {
                        target.innerHTML += lines[l].charAt(c);
                        c++; setTimeout(type, delay);
                    } else {
                        target.innerHTML += "<br>"; l++; c = 0; setTimeout(type, 600);
                    }
                } else if(callback) callback();
            }
            type();
        }

        function nextScene(id) {
            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(`scene-${id === 'final' ? 'final' : id}`);
            target.classList.add('active');

            document.body.className = "style-calm";
            document.getElementById('storm-overlay').style.opacity = "0";
            FX.spawn('clear');
            FX.spawn('creature', 3);

            if (id === 3) {
                const script = [
                    "113 å¹´ 2 æœˆ 17 æ—¥ã€‚",
                    "ä½ ï¼Œæ‰®æ¼”ä¸€ä½æ¢éšªå®¶ï¼Œå¸¶è‘—ä¸€å¼µç¥ç§˜çš„æµ·åœ–ï¼Œ",
                    "ç©¿è¶ŠèŒ«èŒ«å¤§æµ·å¾Œï¼Œä¾†åˆ°é€™ç‰‡æœªçŸ¥çš„å¥‡å¹»æµ·åŸŸâ€¦â€¦",
                    "åœ¨é€™è£¡ï¼Œä½ å°‡å±•é–‹æ–°çš„å†’éšªï¼Œæ­é–‹é€™ç‰‡æµ·åŸŸçš„ç¥ç§˜é¢ç´—ã€‚",
                    "",
                    "é€™ç‰‡æµ·åŸŸèˆ‡ä½ éå»è¦‹éçš„ä»»ä½•åœ°æ–¹éƒ½ä¸åŒã€‚",
                    "æµ·é¢çœ‹ä¼¼å¹³éœï¼Œå»è—è‘—ç„¡æ•¸ç´°å¾®çš„æ³¢å‹•ï¼›",
                    "æŸ”è»Ÿï¼Œå»æ·±ä¸è¦‹åº•ã€‚",
                    "",
                    "ä½ æ¼¸æ¼¸ç™¼ç¾â€”â€”é€™ç‰‡æµ·ï¼Œä¸¦ä¸åªæ˜¯æµ·ã€‚",
                    "å®ƒæ›´åƒæ˜¯ä¸€å€‹äººçš„å…§å¿ƒï¼Œæœ‰æ™‚å®‰éœã€æœ‰æ™‚æ´¶æ¹§ï¼Œ",
                    "å»å§‹çµ‚æº«æŸ”åœ°å­˜åœ¨è‘—ã€‚",
                    "",
                    "è€Œä½ çš„ä»»å‹™ï¼Œä¸¦ä¸æ˜¯å¾æœé€™ç‰‡æµ·åŸŸã€‚",
                    "è€Œæ˜¯é è¿‘å®ƒã€ç†è§£å®ƒï¼Œåœ¨æµªæ½®èˆ‡å¾®å…‰ä¹‹é–“ï¼Œ",
                    "ç™¼ç¾é‚£äº›åªç‚ºä½ å±•é–‹çš„é¢¨æ™¯ã€‚",
                    "",
                    "ç•¶ç„¶â€”â€”é€™å ´æ¢éšªï¼Œä½ ä¸¦ä¸å­¤å–®ã€‚",
                    "ä½ å¸¶è‘—å…©ä½ã€Œå¯æ„›ï¼Œä½†ä¸ä¸€å®šå¯é ã€çš„åŒä¼´â€¦â€¦",
                    "å…©éš»è²“ã€‚ï¼ˆç‰ å€‘å …ç¨±è‡ªå·±æ˜¯å°ˆæ¥­æ¢éšªéšŠã€‚ï¼‰"
                ];
                typewriter('typewriter-box', script, 35, () => {
                    document.getElementById('scene3-btn').classList.remove('hidden');
                });
            }

            if (id === 'final') {
                const lines = [
                    "æ¢ç´¢çš„çµ‚é»ï¼Œçµ‚æ–¼å‡ºç¾åœ¨çœ¼å‰ã€‚",
                    "åœ¨é€™ç‰‡æµ·åŸŸæœ€æ·±è™•ï¼Œå¦³çœ‹è¦‹äº†ä¸€é“æœ¦æœ§çš„èº«å½±â€”â€”",
                    "éœéœåœ°ç«™åœ¨æµ·èˆ‡å…‰çš„äº¤ç•Œä¹‹ä¸­ã€‚",
                    "ä»–æ²’æœ‰é è¿‘ï¼Œå»å§‹çµ‚å­˜åœ¨æ–¼ä½ çš„èˆªç·šè£¡ã€‚",
                    "åƒæµªæ½®ã€åƒå‘¼å¸ã€åƒå¿ƒè·³ã€‚",
                    "",
                    "èº«å½±ï¼š",
                    "ã€Œä½ çµ‚æ–¼ä¾†åˆ°äº†é€™è£¡ã€‚ã€",
                    "ã€Œé€™ç‰‡æµ·åŸŸçš„ç§˜å¯†ï¼Œåªæœ‰ä¸€å€‹äººèƒ½çœŸæ­£æ­é–‹ã€‚ã€",
                    "ã€Œé‚£å°±æ˜¯â€”â€”ä½ ã€‚ã€",
                    "ã€Œä½ é¡˜æ„ï¼Œå’Œæˆ‘ä¸€èµ·æ­é–‹é€™ç‰‡æµ·çš„é¢ç´—å—ï¼Ÿã€"
                ];
                typewriter('final-narrative', lines, 45, () => {
                    document.getElementById('final-ui').classList.remove('hidden');
                });
            }
        }

        function checkPw1() {
            if (document.getElementById('pw1').value === "0313") { FX.levelClear(); nextScene(2); }
            else { document.getElementById('err1').innerText = "æµ·é¢æ²’æœ‰åæ‡‰â€¦â€¦å†æƒ³æƒ³ï¼Ÿ"; }
        }
        function checkPw2() {
            if (document.getElementById('pw2').value === "0417") { FX.levelClear(); nextScene(3); }
            else { document.getElementById('err2').innerText = "ä½ è½è¦‹é æ–¹æœ‰è²“å«è²ï¼šã€Œå–µâ€¦ç­”éŒ¯äº†å•¦ã€‚ã€"; }
        }

        function catSpeech(type) {
            if(type === 'A') {
                state.catAIdx = (state.catAIdx + 1) % catALines.length;
                document.getElementById('catA-msg').innerText = catALines[state.catAIdx];
            } else {
                state.catBIdx = (state.catBIdx + 1) % catBLines.length;
                document.getElementById('catB-msg').innerText = catBLines[state.catBIdx];
            }
        }
        function catEgg(type) { if(type==='A') state.catAClicks++; else state.catBClicks++; if(state.catAClicks+state.catBClicks >= 5) showToast("å–µï¼šå¥½å•¦å¥½å•¦ï¼Œå¿«å»æŠ±æŠ±ä»–ã€‚ ğŸ˜¼"); }

        function runQuest(idx) {
            const stage = document.getElementById('quest-stage');
            stage.innerHTML = "";
            nextScene(5);

            if (idx === 1) {
                typewriter('quest-stage', ["ä»»å‹™ 1ï¼šè£œçµ¦å“é¸æ“‡", "åœ¨å³å°‡å‡ºç™¼ä¹‹å‰ï¼Œä½ å¿…é ˆå¸¶ä¸Šé€™æ¬¡å†’éšªæ‰€éœ€çš„ç³§é£Ÿã€‚", "ä»¥ä¸‹æ˜¯ä½ æ‰‹é‚Šå¯å–å¾—çš„ã€‚"], 35, () => {
                    stage.innerHTML += `
                        <div class="dessert-grid">
                            <div class="dessert-card" onclick="pickFood('æ³¡èŠ™', this)"><img src="https://images.unsplash.com/photo-1628114513681-36f7da65b53d?w=300" alt="æ³¡èŠ™"></div>
                            <div class="dessert-card" onclick="pickFood('å¸ƒæœ—å°¼', this)"><img src="https://images.unsplash.com/photo-1606313564200-e75d5e30476c?w=300" alt="å¸ƒæœ—å°¼"></div>
                            <div class="dessert-card" onclick="pickFood('è‰è“è›‹ç³•', this)"><img src="https://images.unsplash.com/photo-1565958011703-44f9829ba187?w=300" alt="è‰è“è›‹ç³•"></div>
                            <div class="dessert-card" onclick="pickFood('é¬†é¤…', this)"><img src="https://images.unsplash.com/photo-1567620905732-2d1ec7bb7445?w=300" alt="é¬†é¤…"></div>
                        </div><div id="q1-fb" class="mt-4 text-center"></div>`;
                });
            } else if (idx === 2) {
                typewriter('quest-stage', ["ä»»å‹™ 2ï¼šæµ·ä¸Šçš„è²éŸ³", "èˆªè¡Œé€”ä¸­ï¼Œå¦³éœä¸‹å¿ƒä¾†ï¼Œè½è¦‹æµ·é¢¨èˆ‡æµªæ½®ä¹‹é–“ï¼Œ", "ä¼¼ä¹å¤¾é›œè‘—æŸç¨®ç†Ÿæ‚‰çš„è²éŸ³â€¦â€¦å¦³æœ€å¸¸è½è¦‹çš„æ˜¯ï¼Ÿ"], 35, () => {
                    stage.innerHTML += `
                        <div class="flex flex-col gap-3 mt-6">
                            <button class="btn-game" onclick="q2Resp('é‚„å¥½')">é‚„å¥½</button>
                            <button class="btn-game" onclick="q2Resp('é‚„å¯ä»¥')">é‚„å¯ä»¥</button>
                            <button class="btn-game" onclick="q2Resp('é‚„è¡Œ')">é‚„è¡Œ</button>
                            <button class="btn-game" onclick="q2Resp('æˆ‘æ„›ä½ ')">æˆ‘æ„›ä½ </button>
                        </div><div id="q2-fb" class="mt-6 text-center italic text-[var(--gold)] min-h-[1.5rem]"></div>`;
                });
            } else if (idx === 3) {
                document.body.className = "style-storm";
                document.getElementById('storm-overlay').style.opacity = "1";
                FX.spawn('rain', 60);
                const sLoop = setInterval(() => { if(document.body.className!=="style-storm") clearInterval(sLoop); else { FX.lightning(); } }, 4000);
                typewriter('quest-stage', ["ä»»å‹™ 3ï¼šé¢¨æš´ä¹‹åœ°", "é¢¨å‘è®Šå¾—æ··äº‚ï¼Œæµ·é¢é–‹å§‹ä¸å®‰åœ°èµ·ä¼ã€‚", "å¦³ä¾†åˆ°äº†ä¸€ç‰‡æ°£æ°›ç·Šç¹ƒçš„æœªçŸ¥åœ°å¸¶ã€‚å¦³æœƒé¸æ“‡â€”â€”"], 35, () => {
                    stage.innerHTML += `
                        <div class="flex flex-col gap-3 mt-6">
                            <button class="btn-game" onclick="q3Resp()">å†·æˆ°</button>
                            <button class="btn-game" onclick="q3Resp()">å¤§è²å’†å˜¯</button>
                            <button class="btn-game" onclick="q3Resp()">ç›´æ¥é–‹æ‰</button>
                        </div>`;
                });
            } else if (idx === 4) {
                FX.spawn('clear'); FX.spawn('bubble', 25);
                typewriter('quest-stage', ["ä»»å‹™ 4ï¼šæ·±æµ·ä¹‹ä¸‹", "æµ·é¢ç¸½æ˜¯çœ‹èµ·ä¾†å¹³éœï¼Œå»æ²’äººçœŸæ­£çŸ¥é“æ·±æµ·ä¸‹è—è‘—ä»€éº¼ã€‚", "è‹¥æƒ³çœŸæ­£ç†è§£é€™ç‰‡æµ·ï¼Œå¦³è¦ºå¾—æœ€éœ€è¦çš„æ˜¯ï¼Ÿ"], 35, () => {
                    stage.innerHTML += `
                        <div class="grid grid-cols-2 gap-4 mt-8">
                            <label class="btn-game flex items-center justify-center gap-2"><input type="checkbox" value="å‹‡æ°£"> å‹‡æ°£</label>
                            <label class="btn-game flex items-center justify-center gap-2"><input type="checkbox" value="è€å¿ƒ"> è€å¿ƒ</label>
                            <label class="btn-game flex items-center justify-center gap-2"><input type="checkbox" value="å¥½å¥‡å¿ƒ"> å¥½å¥‡å¿ƒ</label>
                            <label class="btn-game flex items-center justify-center gap-2"><input type="checkbox" value="æº«æŸ”"> æº«æŸ”</label>
                        </div>
                        <button class="btn-game w-full mt-10" onclick="q4Done()">æ²‰å…¥æ·±æµ·...</button>`;
                });
            }
        }

        function pickFood(name, el) {
            state.chosenDessert = name;
            document.querySelectorAll('.dessert-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('q1-fb').innerHTML = `<p>ä½ é¸æ“‡äº†ã€Œ${name}ã€ç•¶ä½œè£œçµ¦å“ä¾†è¸ä¸Šå†’éšªã€‚</p><p class="text-[var(--pink-purple)] mt-1">å–µï¼šé€™å€‹é¸æ“‡ä¸éŒ¯ï¼æˆ‘éƒ½æƒ³åƒäº†ã€‚</p><button class="btn-game mt-6 w-full" onclick="runQuest(2)">ä¸‹ä¸€å€‹ä»»å‹™</button>`;
        }

        function q2Resp(v) {
            const fb = document.getElementById('q2-fb');
            if (v === 'æˆ‘æ„›ä½ ') { FX.levelClear(); fb.innerText = "â€¦â€¦ å°ã€‚ å°±æ˜¯é€™å€‹ã€‚"; setTimeout(() => runQuest(3), 1500); }
            else { 
                const ms = { 'é‚„å¥½': "çœŸçš„é‚„å¥½ã€‚ä½†é‚„å¥½ä¸æ˜¯é€™å€‹ã€‚", 'é‚„å¯ä»¥': "æˆ‘çŸ¥é“é‚„å¯ä»¥ï¼Œä½†é‚„å¯ä»¥é¸åˆ¥çš„ã€‚", 'é‚„è¡Œ': "é‚„è¡Œï¼Œä½† å¥½åƒé‚„æ˜¯ä¸è¡Œã€‚" };
                fb.innerText = ms[v];
                setTimeout(() => fb.innerText = "", 1500);
            }
        }

        // âœ… ç”¨ä¿®æ­£ç‰ˆå–ä»£ï¼šq3Respï¼ˆæ¸…æ‰é›¨æ»´/ç‰¹æ•ˆï¼Œé¿å…ç´¯ç©ï¼‰
        function q3Resp() {
            // æ¸…æ‰é›¨æ»´/ç‰¹æ•ˆï¼Œé¿å…ç´¯ç©
            FX.spawn('clear');

            // é¢¨æš´çµæŸï¼Œå›åˆ°å¹³éœ
            document.body.className = "style-calm";
            document.getElementById('storm-overlay').style.opacity = "0";

            // è£œå›æµ·æ´‹èƒŒæ™¯ç”Ÿç‰©
            FX.spawn('creature', 3);

            const stage = document.getElementById('quest-stage');
            stage.innerHTML = "";
            typewriter('quest-stage', ["åœ¨ä»»ä½•æ—…ç¨‹ä¸­ï¼Œè¡çªèˆ‡é¢¨æµªéƒ½ç„¡æ³•é¿å…ã€‚", "æœ‰æ™‚å€™æœƒæ²‰é»˜ï¼Œæœ‰æ™‚å€™æœƒæƒ…ç·’ä¸Šä¾†ï¼Œç”šè‡³æœƒèªªå‡ºä¸é‚£éº¼æº«æŸ”çš„è©±ã€‚", "ä½†â€”â€”æœ€çµ‚ï¼Œéƒ½æœƒèµ°å›å½¼æ­¤èº«é‚Šã€‚"], 40, () => {
                stage.innerHTML += `<button class="btn-game mt-8 w-full" onclick="runQuest(4)">ä¸‹ä¸€å€‹ä»»å‹™</button>`;
            });
        }

        function q4Done() {
            const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
            state.chosenValues = checked;
            const valStr = checked.length > 0 ? `ä½†è¨˜å¾—å¦³èªªéï¼Œå¦³æœƒç”¨(${checked.join(')ã€(')})ä¾†æ¢ç´¢ã€‚` : "";
            const stage = document.getElementById('quest-stage');
            stage.innerHTML = "";
            typewriter('quest-stage', ["é è¿‘ä¸€ç‰‡æµ·ï¼Œå¾ä¾†éƒ½ä¸æ˜¯ç°¡å–®çš„äº‹ã€‚", "ä½†åªè¦é¡˜æ„ç†è§£â€”â€”é‚£ç‰‡æµ·ï¼Œçµ‚ç©¶æœƒç‚ºå¦³è®Šå¾—é€æ˜ã€‚", valStr], 40, () => {
                stage.innerHTML += `<button class="btn-game mt-8 w-full" onclick="nextScene('final')">å‰å¾€æµ·åŸŸæ ¸å¿ƒ</button>`;
            });
        }

        function checkFinal() {
            const ans = document.getElementById('final-ans').value;
            if (ans === "å¥‡ç¾" || ans === "å¥‡ç¾åšç‰©é¤¨") {
                FX.levelClear(); nextScene(6);
                const script = [
                    "æ­å–œä½ ï¼Œæ¢ç´¢å®Œé€™ç‰‡ç¥ç§˜æµ·åŸŸã€‚",
                    "ä½†â€¦â€¦",
                    "ä½ ä»¥ç‚ºä½ æ‰¾åˆ°äº†é€™ç‰‡æµ·ï¼Œå…¶å¯¦â€”â€”",
                    "æˆ‘ä¹Ÿåœ¨äººæµ·ä¸­æ‰¾åˆ°äº†ä½ ã€‚",
                    "å¦‚æœæœªä¾†ä¹Ÿæœ‰é¢¨æµªï¼Œæˆ‘æƒ³æŠŠæˆ‘çš„æ‰‹ï¼Œæ”¾åœ¨ä½ æ‰‹ä¸Šã€‚",
                    "æ¢éšªé‚„æ²’çµæŸã€‚ä½ é¡˜æ„ç¹¼çºŒé™ªæˆ‘èˆªè¡Œå—ï¼Ÿ"
                ];
                typewriter('ending-narrative', script, 50, () => { document.getElementById('ending-ui').classList.remove('hidden'); });
            } else { showToast("æµ·é¢èµ·äº†éœ§ï¼Œå†æƒ³ä¸€ä¸‹ã€‚"); }
        }

        function handleWait() {
            const btn = document.getElementById('think-btn');
            btn.innerText = "â€¦â€¦";
            setTimeout(() => { 
                btn.innerText = "æˆ‘é¡˜æ„"; 
                btn.onclick = triggerEnding;
                showToast("å–µï¼šè£ä»€éº¼çŒ¶è±« ğŸ˜¼");
            }, 1500);
        }

        function triggerEnding() {
            nextScene('blessing');
            const lines = [`å°äº†ï¼Œé—œæ–¼ä½ é¸çš„é‚£ä»½è£œçµ¦å“â€”â€”`, `ä¸‹æ¬¡ï¼Œæˆ‘å¸¶ä½ å»åƒã€Œ${state.chosenDessert}ã€ã€‚` ];
            typewriter('recall-area', lines, 50, () => {
                setTimeout(() => {
                    document.getElementById('recall-area').classList.add('hidden');
                    document.getElementById('blessing-area').classList.remove('hidden');
                    document.body.className = "style-dawn";
                    FX.spawn('gold', 40);
                }, 3000);
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast-msg');
            t.innerText = msg; t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 3000);
        }

        window.onload = () => {
            FX.spawn('creature', 3);
            const title = document.getElementById('final-title');
            let timer;
            title.onmousedown = () => timer = setTimeout(() => showToast("å…¶å¯¦æˆ‘ç·´ç¿’äº†å¾ˆå¤šæ¬¡ï¼Œæ‰æ•¢æŠŠé€™é çµ¦ä½ ã€‚"), 2000);
            title.onmouseup = () => clearTimeout(timer);
        };
    </script>
</body>
</html>
