<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒŠ æœªçŸ¥æµ·åŸŸ Â· ç¦èˆªå€</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Cinzel:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg-deep: #020b14;
      --ocean-blue: #0B2D4A;
      --moonlight: #7CD6FF;
      --gold: #F7D77A;
      --pink-purple: #C9A7FF;
      --text-main: #EAF6FF;
      --text-sub: rgba(234,246,255,0.75);
      --err-red: #FF6B6B;
      --card-bg: rgba(7, 26, 43, 0.7);
      --accent-glow: 0 0 20px rgba(124, 214, 255, 0.3);
    }

    body {
      background-color: var(--bg-deep);
      color: var(--text-main);
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0; overflow: hidden; height: 100vh;
      display: flex; justify-content: center; align-items: center;
      transition: background 2s ease-in-out;
    }

    #fx-layer { position: fixed; inset: 0; z-index: 2; pointer-events: none; }

    .waves-container { position: fixed; bottom: 0; width: 100%; height: 20vh; z-index: 1; pointer-events: none; }
    .waves { width: 100%; height: 100%; min-height: 100px; }
    .parallax > use { animation: move-forever 25s cubic-bezier(.55,.5,.45,.5) infinite; }
    .parallax > use:nth-child(1) { animation-delay: -2s; animation-duration: 7s; }
    .parallax > use:nth-child(2) { animation-delay: -3s; animation-duration: 10s; }
    .parallax > use:nth-child(3) { animation-delay: -4s; animation-duration: 13s; }
    .parallax > use:nth-child(4) { animation-delay: -5s; animation-duration: 20s; }
    @keyframes move-forever { 0% { transform: translate3d(-90px,0,0); } 100% { transform: translate3d(85px,0,0); } }

    .storm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: 1s; z-index: 5; pointer-events: none; }
    .lightning-flash { position: fixed; inset: 0; background: white; opacity: 0; z-index: 50; pointer-events: none; }
    .rain-drop { position: absolute; background: rgba(255,255,255,0.4); width: 1.5px; height: 40px; pointer-events: none; animation: rain-fall linear infinite; }
    @keyframes rain-fall { to { transform: translateY(110vh); } }

    .gold-dust { position: absolute; border-radius: 50%; background: var(--gold); box-shadow: 0 0 10px var(--gold); pointer-events: none; animation: gold-fall linear forwards; }
    @keyframes gold-fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(124, 214, 255, 0.2); border-radius: 40px;
      padding: 3rem;
      width: 92%;
      max-width: 680px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8), inset 0 0 40px rgba(124, 214, 255, 0.05);
      position: relative; z-index: 10;
    }

    .title-font { font-family: 'Cinzel', serif; letter-spacing: 0.2em; }
    .glow-text { text-shadow: 0 0 15px var(--moonlight); color: var(--moonlight); }
    .gold-text { text-shadow: 0 0 15px var(--gold); color: var(--gold); }

    .btn-game {
      background: rgba(124, 214, 255, 0.05);
      border: 2px solid var(--moonlight); color: var(--moonlight);
      padding: 0.8rem 2.5rem; border-radius: 100px;
      transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer; font-weight: bold; position: relative; overflow: hidden;
      letter-spacing: 1px;
    }
    .btn-game:hover {
      background: var(--moonlight); color: var(--bg-deep);
      box-shadow: 0 0 30px var(--moonlight); transform: translateY(-5px) scale(1.05);
    }
    .btn-game:active { transform: translateY(2px); }

    .q3-choice.selected {
      background: var(--moonlight);
      color: var(--bg-deep);
      box-shadow: 0 0 30px var(--moonlight);
      transform: translateY(-2px) scale(1.03);
    }

    .input-game {
      background: rgba(0,0,0,0.5); border-bottom: 2px solid var(--moonlight);
      text-align: center; width: 100%; padding: 1.2rem;
      outline: none; color: var(--gold); font-size: 1.8rem; margin: 1.5rem 0;
      transition: 0.3s;
    }
    .input-game:focus { border-bottom-color: var(--gold); text-shadow: 0 0 10px var(--gold); }

    .cat-dialogue {
      position: relative; background: #fff; color: #071A2B;
      padding: 14px 20px; border-radius: 20px; font-size: 0.9rem;
      margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      min-height: 60px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-weight: 600; animation: float 3s ease-in-out infinite;
    }
    .cat-dialogue::after {
      content: ''; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
      border-width: 12px 12px 0; border-style: solid; border-color: #fff transparent transparent;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    .dessert-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 25px 0; }
    .dessert-card {
      border-radius: 24px; border: 4px solid transparent;
      overflow: hidden; cursor: pointer; transition: 0.4s; height: 140px;
      background: #000;
    }
    .dessert-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.4s; }
    .dessert-card:hover img { opacity: 1; transform: scale(1.1); }
    .dessert-card.selected { border-color: var(--gold); box-shadow: 0 0 35px var(--gold); transform: scale(1.1); }

    .scene { display: none; }
    .scene.active { display: block; animation: scene-fade-up 0.8s forwards; }
    @keyframes scene-fade-up { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

    .toast {
      position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
      background: var(--gold); color: #000; padding: 12px 30px;
      border-radius: 100px; font-weight: 800; opacity: 0; z-index: 100;
      pointer-events: none; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 15px 40px rgba(247,215,122,0.4);
    }

    .style-calm { background: radial-gradient(circle at center, #0B2D4A 0%, #020b14 100%); }
    .style-storm { background: #000; }
    .style-dawn { background: linear-gradient(180deg, #001524 0%, #1a759f 60%, #ffcfd2 100%); }

    .shake-screen { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }

    .level-clear-banner {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 4.5rem; font-family: 'Cinzel'; font-weight: 900; color: var(--gold);
      text-shadow: 0 0 30px var(--gold); opacity: 0; z-index: 100; pointer-events: none;
      text-align: center; white-space: nowrap;
    }
    .banner-pop { animation: banner-pop 1.5s ease-out forwards; }
    @keyframes banner-pop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); letter-spacing: -10px; }
      40% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); letter-spacing: 8px; }
      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); letter-spacing: 5px; }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
    }
    .scroll-box{
      max-height: 45vh;
      overflow-y: auto;
      padding-right: 6px;
      -webkit-overflow-scrolling: touch;
   }
  </style>
</head>

<body class="style-calm">
  <div id="fx-layer"></div>
  <div id="storm-overlay" class="storm-overlay"></div>
  <div id="lightning-flash" class="lightning-flash"></div>
  <div id="level-clear" class="level-clear-banner">æˆåŠŸè§£é–</div>
  <div id="toast-msg" class="toast"></div>

  <div class="waves-container">
    <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" /></defs>
      <g class="parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(12, 45, 74, 0.7)" />
        <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(11, 45, 74, 0.5)" />
        <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(10, 30, 60, 0.3)" />
        <use xlink:href="#gentle-wave" x="48" y="7" fill="rgba(7, 26, 43, 1)" />
      </g>
    </svg>
  </div>

  <main class="glass-card" id="game-container">
    <div id="scene-0" class="scene active text-center">
      <div class="mb-10 flex justify-center opacity-90">
        <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="var(--moonlight)" stroke-width="1" class="animate-[spin_20s_linear_infinite]">
          <circle cx="12" cy="12" r="10"/>
          <path d="m16.24 7.76-1.41 4.25-4.25 1.41 1.41-4.25 4.25-1.41Z"/>
          <circle cx="12" cy="12" r="0.5" fill="currentColor"/>
          <path d="M12 2v2M12 20v2M2 12h2M20 12h2" stroke-opacity="0.5"/>
        </svg>
      </div>
      <h1 class="text-xl sm:text-3xl mb-4 title-font font-bold glow-text whitespace-nowrap">ğŸŒŠ æœªçŸ¥æµ·åŸŸ Â· ç¦èˆªå€ ğŸŒŠ</h1>
      <p class="text-sm mb-16 tracking-[0.5em] text-[var(--text-sub)] uppercase">Only for the true explorers</p>
      <button class="btn-game" onclick="nextScene(1)">é–‹å§‹èˆªè¡Œ START</button>
    </div>

    <div id="scene-1" class="scene text-center">
      <h2 class="text-2xl mb-8 title-font glow-text">èˆªæµ·æª¢å®š I</h2>
      <p class="text-sm mb-2 opacity-80">è«‹è¼¸å…¥ç”Ÿæ—¥å››ç¢¼</p>
      <input type="password" id="pw1" class="input-game" maxlength="4" autocomplete="off" placeholder="â€¢â€¢â€¢â€¢">
      <div id="err1" class="text-xs text-[var(--err-red)] h-4 font-bold mb-6"></div>
      <button class="btn-game" onclick="checkPw1()">ç¢ºèªæŒ‡ä»¤</button>
    </div>

    <div id="scene-2" class="scene text-center">
      <h2 class="text-2xl mb-8 title-font glow-text">èˆªæµ·æª¢å®š II</h2>
      <p class="text-sm mb-2 opacity-80">è«‹è¼¸å…¥å°æ–¹ç”Ÿæ—¥ï¼ˆå››ç¢¼ï¼‰</p>
      <input type="password" id="pw2" class="input-game" maxlength="4" autocomplete="off" placeholder="â€¢â€¢â€¢â€¢">
      <div id="err2" class="text-xs text-[var(--err-red)] h-4 font-bold mb-6"></div>
      <button class="btn-game" onclick="checkPw2()">å•Ÿå‹•å…¥å£</button>
    </div>

    <div id="scene-3" class="scene relative">
      <div id="typewriter-box" class="mono-font text-[0.95rem] leading-loose text-left max-h-[400px] overflow-y-auto pr-2"></div>
      <div class="text-center mt-10">
        <button id="scene3-btn" class="btn-game hidden" onclick="nextScene(4)">å¬å–šéšŠå‹ RECRUIT</button>
      </div>
    </div>

    <div id="scene-4" class="scene">
      <h2 class="text-2xl mb-12 text-center title-font glow-text">å°ˆæ¥­æ¢éšªéšŠ</h2>
      <div class="flex justify-around items-end gap-6 mb-12">
        <div class="flex flex-col items-center w-1/2">
          <div class="cat-dialogue" onclick="catSpeech('A')">
            <span id="catA-msg" class="text-center">å–µï¼šæˆ‘åªæ˜¯è·¯é...</span>
          </div>
          <div class="relative group">
            <div class="absolute inset-0 bg-moonlight blur-lg opacity-0 group-hover:opacity-40 transition rounded-full"></div>
            <img src="./images/catA.jpg" class="w-28 h-28 rounded-full border-4 border-[var(--moonlight)] relative z-10 shadow-2xl cursor-pointer hover:scale-110 transition object-cover" onclick="catEgg('A')">
          </div>
          <p class="text-[0.7rem] mt-4 font-bold text-[var(--pink-purple)] tracking-widest bg-white/5 px-3 py-1 rounded-full">æµ·åœ–å®ˆè­·è€…</p>
        </div>
        <div class="flex flex-col items-center w-1/2">
          <div class="cat-dialogue" onclick="catSpeech('B')">
            <span id="catB-msg" class="text-center">å–µï¼šæˆ‘å€‘è¦å»å“ªï¼Ÿ</span>
          </div>
          <div class="relative group">
            <div class="absolute inset-0 bg-moonlight blur-lg opacity-0 group-hover:opacity-40 transition rounded-full"></div>
            <img src="./images/catB.jpg" class="w-28 h-28 rounded-full border-4 border-[var(--moonlight)] relative z-10 shadow-2xl cursor-pointer hover:scale-110 transition object-cover" onclick="catEgg('B')">
          </div>
          <p class="text-[0.7rem] mt-4 font-bold text-[var(--pink-purple)] tracking-widest bg-white/5 px-3 py-1 rounded-full">æµªèŠ±åµå¯Ÿå“¡</p>
        </div>
      </div>
      <div class="text-center">
        <button class="btn-game" onclick="runQuest(1)">é–‹å§‹ä»»å‹™ START MISSION</button>
      </div>
    </div>

    <div id="scene-5" class="scene">
      <div id="quest-stage" class="scroll-box text-[1rem] leading-relaxed text-left"></div>
    </div>

    <div id="scene-final" class="scene text-center">
      <div class="mb-8 flex justify-center">
        <svg width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" class="animate-pulse">
          <path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8L12 2Z"/>
          <circle cx="12" cy="12" r="11" stroke-dasharray="2 4"/>
        </svg>
      </div>
      <h2 id="final-title" class="text-3xl mb-8 title-font gold-text font-bold">æµ·åŸŸæ ¸å¿ƒ Â· æœªçŸ¥ä¹‹å¢ƒ</h2>
      <div id="final-narrative" class="scroll-box text-[0.95rem] mb-10 leading-loose text-left"></div>
      <div id="final-ui" class="hidden">
        <p class="text-sm mb-4 opacity-80">å±¬æ–¼æˆ‘å€‘çš„ å›æ†¶ä¹‹åœ° æ˜¯ï¼Ÿ</p>
        <input type="text" id="final-ans" class="input-game" placeholder="åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ">
        <button class="btn-game" onclick="checkFinal()">æ­é–‹é¢ç´— REVEAL</button>
      </div>
    </div>

    <div id="scene-6" class="scene text-center">
      <div id="ending-narrative" class="scroll-box text-[1.05rem] leading-loose mb-12 text-left"></div>
      <div id="ending-ui" class="hidden flex flex-col gap-6">
        <button class="btn-game text-xl" onclick="triggerEnding()">æˆ‘é¡˜æ„</button>
        <button id="think-btn" class="text-xs text-[var(--text-sub)] underline opacity-50 hover:opacity-100 transition" onclick="handleWait()">æˆ‘è¦å…ˆæƒ³ä¸€ä¸‹</button>
      </div>
    </div>

    <div id="scene-blessing" class="scene text-center">
      <div id="recall-area" class="scroll-box text-xl mb-12 font-bold glow-text"></div>
      <div id="blessing-area" class="hidden">
        <h1 class="text-2xl sm:text-3xl mb-10 title-font gold-text drop-shadow-[0_0_20px_rgba(247,215,122,0.6)] whitespace-nowrap">ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚</h1>
        <div class="text-[1.1rem] leading-loose mb-20 space-y-6">
          <p>é¡˜æˆ‘çš„æº«æŸ”åƒå¤§æµ·ä¸€æ¨£ï¼Œ</p>
          <p>åœ¨ä½ éœ€è¦çš„æ™‚å€™æ“æŠ±ä½ ã€é™ªè‘—ä½ ã€‚</p>
          <p>ç”Ÿæ—¥å¿«æ¨‚ï¼Œä¹Ÿè¬è¬ä½ é¡˜æ„é è¿‘æˆ‘ã€‚</p>
          <span class="mt-20 block font-bold text-3xl tracking-widest glow-text">â€”â€” ä½ çš„é‚£ç‰‡æµ· JT</span>
        </div>
        <div class="flex justify-center gap-14 mt-10">
          <span class="cursor-pointer opacity-40 hover:opacity-100 hover:scale-150 transition-all text-4xl" onclick="showToast('å½©è›‹ Aï¼šå¿«å»æŠ±æŠ±ä»–å§ ğŸ±')">ğŸ±</span>
          <span class="cursor-pointer opacity-40 hover:opacity-100 hover:scale-150 transition-all text-4xl" onclick="showToast('å½©è›‹ Cï¼šå¦³æ˜¯æˆ‘æœ€å–œæ­¡çš„èˆªç·š âœ¨')">âœ¨</span>
          <span class="cursor-pointer opacity-40 hover:opacity-100 hover:scale-150 transition-all text-4xl" onclick="showToast('å½©è›‹ Bï¼šæ„›å¦³å”· â¤ï¸')">â¤ï¸</span>
        </div>
        <button class="mt-24 text-[0.7rem] opacity-20 uppercase tracking-[0.5em] hover:opacity-100 transition" onclick="location.reload()">RE-EXPLORE THE SEA</button>
      </div>
    </div>
  </main>

  <script>
    const state = {
      chosenDessert: "",
      chosenValues: [],
      catAIdx: 0, catBIdx: 0,
      catAClicks: 0, catBClicks: 0,
      q3Choice: ""
    };

    const catALines = ["å–µï¼šæˆ‘åªæ˜¯è·¯éï¼Œé †ä¾¿ç•¶ä½ çš„å‰¯éšŠé•·ã€‚", "å–µï¼šæˆ‘æœ‰ä¸€ç¨®é æ„Ÿâ€¦ä½ æœƒè¿·è·¯ã€‚", "å–µï¼šå¦‚æœæœ‰å¯¶è—ï¼Œå…ˆå¯«æˆ‘åå­—ã€‚"];
    const catBLines = ["å–µï¼šæˆ‘å€‘è¦å»å“ªï¼Ÿå¯ä»¥å…ˆåƒç½ç½å—ï¼Ÿ", "å–µï¼šæˆ‘è² è²¬å¯æ„›ï¼Œä½ è² è²¬åŠªåŠ›ã€‚", "å–µï¼šå‰æ–¹æœ‰å±éšªâ€¦ä½†æˆ‘å¿˜äº†æ˜¯å“ªè£¡ã€‚"];

    const FX = {
      clear() { document.getElementById('fx-layer').innerHTML = ""; },

      rain(active) {
        const layer = document.getElementById('fx-layer');
        if(!active) return;
        for(let i=0; i<80; i++) {
          const r = document.createElement('div');
          r.className = 'rain-drop';
          r.style.left = Math.random() * 100 + 'vw';
          r.style.top = Math.random() * -100 + 'vh';
          r.style.opacity = Math.random() * 0.5 + 0.2;
          r.style.animationDuration = (Math.random() * 0.5 + 0.4) + 's';
          r.style.animationDelay = (Math.random() * 2) + 's';
          layer.appendChild(r);
        }
      },

      lightning() {
        const flash = document.getElementById('lightning-flash');
        const main = document.body;
        flash.style.opacity = "0.8";
        main.classList.add('shake-screen');
        setTimeout(() => {
          flash.style.opacity = "0";
          main.classList.remove('shake-screen');
        }, 150);
      },

      goldDust() {
        const layer = document.getElementById('fx-layer');
        for(let i=0; i<50; i++) {
          setTimeout(() => {
            const d = document.createElement('div');
            d.className = 'gold-dust';
            const size = Math.random() * 5 + 2;
            d.style.width = d.style.height = size + 'px';
            d.style.left = Math.random() * 100 + 'vw';
            d.style.animationDuration = (Math.random() * 3 + 4) + 's';
            layer.appendChild(d);
            setTimeout(() => d.remove(), 7000);
          }, i * 150);
        }
      },

      levelClear(text = "æˆåŠŸè§£é–") {
        const b = document.getElementById('level-clear');
        b.textContent = text;
        b.classList.remove('banner-pop');
        void b.offsetWidth;
        b.classList.add('banner-pop');
      }
    };

    function typewriter(id, lines, delay = 40, callback) {
      const target = document.getElementById(id);
      target.innerHTML = "";
      let l = 0, c = 0;
      function type() {
        if(l < lines.length) {
          if(c < lines[l].length) {
            target.innerHTML += lines[l].charAt(c);
            c++; setTimeout(type, delay);
          } else {
            target.innerHTML += "<br>"; l++; c = 0; setTimeout(type, 600);
          }
        } else if(callback) callback();
        target.scrollTop = target.scrollHeight;
      }
      type();
    }

    function nextScene(id) {
      document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
      const target = document.getElementById(
        id === 'final' ? 'scene-final' :
        (id === 'blessing' ? 'scene-blessing' : `scene-${id}`)
      );
      target.classList.add('active');

      if(id !== 5) {
        document.body.className = "style-calm";
        document.getElementById('storm-overlay').style.opacity = "0";
        FX.clear();
      }

      if (id === 3) {
        const script = [
          "113 å¹´ 2 æœˆ 17 æ—¥ã€‚",
          "ä½ ï¼Œæ‰®æ¼”ä¸€ä½æ¢éšªå®¶ï¼Œå¸¶è‘—ä¸€å¼µç¥ç§˜çš„æµ·åœ–ï¼Œ",
          "ç©¿è¶ŠèŒ«èŒ«å¤§æµ·å¾Œï¼Œä¾†åˆ°é€™ç‰‡æœªçŸ¥çš„å¥‡å¹»æµ·åŸŸâ€¦â€¦",
          "",
          "é€™ç‰‡æµ·åŸŸèˆ‡ä½ éå»è¦‹éçš„ä»»ä½•åœ°æ–¹éƒ½ä¸åŒã€‚",
          "æµ·é¢çœ‹ä¼¼å¹³éœï¼Œå»è—è‘—ç„¡æ•¸ç´°å¾®çš„æ³¢å‹•ï¼›",
          "æŸ”è»Ÿï¼Œå»æ·±ä¸è¦‹åº•ã€‚",
          "",
          "ä½ æ¼¸æ¼¸ç™¼ç¾â€”â€”é€™ç‰‡æµ·ï¼Œä¸¦ä¸åªæ˜¯æµ·ã€‚",
          "å®ƒæ›´åƒæ˜¯ä¸€å€‹äººçš„å…§å¿ƒï¼Œæœ‰æ™‚å®‰éœã€æœ‰æ™‚æ´¶æ¹§ï¼Œ",
          "å»å§‹çµ‚æº«æŸ”åœ°å­˜åœ¨è‘—ã€‚",
          "",
          "è€Œä½ çš„ä»»å‹™ï¼Œä¸¦ä¸æ˜¯å¾æœé€™ç‰‡æµ·åŸŸã€‚",
          "è€Œæ˜¯é è¿‘å®ƒã€ç†è§£å®ƒï¼Œåœ¨æµªæ½®èˆ‡å¾®å…‰ä¹‹é–“ï¼Œ",
          "ç™¼ç¾é‚£äº›åªç‚ºä½ å±•é–‹çš„é¢¨æ™¯ã€‚",
          "",
          "ç•¶ç„¶â€”â€”é€™å ´æ¢éšªï¼Œä½ ä¸¦ä¸å­¤å–®ã€‚",
          "ä½ å¸¶è‘—å…©ä½ã€Œå¯æ„›ï¼Œä½†ä¸ä¸€å®šå¯é ã€çš„åŒä¼´â€¦â€¦",
          "å…©éš»è²“ã€‚ï¼ˆç‰ å€‘å …ç¨±è‡ªå·±æ˜¯å°ˆæ¥­æ¢éšªéšŠã€‚ï¼‰"
        ];
        typewriter('typewriter-box', script, 35, () => {
          document.getElementById('scene3-btn').classList.remove('hidden');
        });
      }

      if (id === 'final') {
        const lines = [
          "æ¢ç´¢çš„çµ‚é»ï¼Œçµ‚æ–¼å‡ºç¾åœ¨çœ¼å‰ã€‚",
          "åœ¨é€™ç‰‡æµ·åŸŸæœ€æ·±è™•ï¼Œå¦³çœ‹è¦‹äº†ä¸€é“æœ¦æœ§çš„èº«å½±â€”â€”",
          "éœéœåœ°ç«™åœ¨æµ·èˆ‡å…‰çš„äº¤ç•Œä¹‹ä¸­ã€‚",
          "ä»–æ²’æœ‰é è¿‘ï¼Œå»å§‹çµ‚å­˜åœ¨æ–¼ä½ çš„èˆªç·šè£¡ã€‚",
          "åƒæµªæ½®ã€åƒå‘¼å¸ã€åƒå¿ƒè·³ã€‚",
          "",
          "èº«å½±ï¼š",
          "ã€Œä½ çµ‚æ–¼ä¾†åˆ°äº†é€™è£¡ã€‚ã€",
          "ã€Œé€™ç‰‡æµ·åŸŸçš„ç§˜å¯†ï¼Œåªæœ‰ä¸€å€‹äººèƒ½çœŸæ­£æ­é–‹ã€‚ã€",
          "ã€Œé‚£å°±æ˜¯â€”â€”ä½ ã€‚ã€",
          "ã€Œä½ é¡˜æ„ï¼Œå’Œæˆ‘ä¸€èµ·æ­é–‹é€™ç‰‡æµ·çš„é¢ç´—å—ï¼Ÿã€"
        ];
        typewriter('final-narrative', lines, 45, () => {
          document.getElementById('final-ui').classList.remove('hidden');
        });
      }
    }

    function checkPw1() {
      if (document.getElementById('pw1').value === "0313") {
        FX.levelClear("æˆåŠŸè§£é–");
        nextScene(2);
      } else {
        document.getElementById('err1').innerText = "æµ·é¢æ²’æœ‰åæ‡‰â€¦â€¦å†æƒ³æƒ³ï¼Ÿ";
      }
    }

    function checkPw2() {
      if (document.getElementById('pw2').value === "0417") {
        FX.levelClear("æˆåŠŸè§£é–");
        nextScene(3);
      } else {
        document.getElementById('err2').innerText = "ä½ è½è¦‹é æ–¹æœ‰è²“å«è²ï¼šã€Œå–µâ€¦ç­”éŒ¯äº†å•¦ã€‚ã€";
      }
    }

    function catSpeech(type) {
      if(type === 'A') {
        state.catAIdx = (state.catAIdx + 1) % catALines.length;
        document.getElementById('catA-msg').innerText = catALines[state.catAIdx];
      } else {
        state.catBIdx = (state.catBIdx + 1) % catBLines.length;
        document.getElementById('catB-msg').innerText = catBLines[state.catBIdx];
      }
    }

    function catEgg(type) {
      if(type==='A') state.catAClicks++; else state.catBClicks++;
      if(state.catAClicks+state.catBClicks >= 5) showToast("å–µï¼šå¥½å•¦å¥½å•¦ï¼Œå¿«å»æŠ±æŠ±ä»–ã€‚ ğŸ˜¼");
    }

    function runQuest(idx) {
      const stage = document.getElementById('quest-stage');
      stage.innerHTML = "";
      nextScene(5);

      if (idx === 1) {
        typewriter('quest-stage', ["ä»»å‹™ 1ï¼šè£œçµ¦å“é¸æ“‡", "åœ¨å³å°‡å‡ºç™¼ä¹‹å‰ï¼Œä½ å¿…é ˆå¸¶ä¸Šé€™æ¬¡å†’éšªæ‰€éœ€çš„ç³§é£Ÿã€‚", "ä»¥ä¸‹æ˜¯ä½ æ‰‹é‚Šå¯å–å¾—çš„ã€‚"], 35, () => {
          stage.innerHTML += `
            <div class="dessert-grid">
              <div class="dessert-card" onclick="pickFood('æ³¡èŠ™', this)"><img src="./images/D1.jpg" alt="æ³¡èŠ™"></div>
              <div class="dessert-card" onclick="pickFood('å¸ƒæœ—å°¼', this)"><img src="./images/D2.jpg" alt="å¸ƒæœ—å°¼"></div>
              <div class="dessert-card" onclick="pickFood('è‰è“è›‹ç³•', this)"><img src="./images/D3.jpg" alt="è‰è“è›‹ç³•"></div>
              <div class="dessert-card" onclick="pickFood('é¬†é¤…', this)"><img src="./images/D4.jpg" alt="é¬†é¤…"></div>
            </div>
            <div id="q1-fb" class="mt-4 text-center"></div>
          `;
        });
      }

      else if (idx === 2) {
        typewriter('quest-stage', ["ä»»å‹™ 2ï¼šæµ·ä¸Šçš„è²éŸ³", "èˆªè¡Œé€”ä¸­ï¼Œå¦³éœä¸‹å¿ƒä¾†ï¼Œè½è¦‹æµ·é¢¨èˆ‡æµªæ½®ä¹‹é–“ï¼Œ", "ä¼¼ä¹å¤¾é›œè‘—æŸç¨®ç†Ÿæ‚‰çš„è²éŸ³â€¦â€¦å¦³æœ€å¸¸è½è¦‹çš„æ˜¯ï¼Ÿ"], 35, () => {
          stage.innerHTML += `
            <div class="flex flex-col gap-4 mt-8">
              <button class="btn-game" onclick="q2Resp('é‚„å¥½')">é‚„å¥½</button>
              <button class="btn-game" onclick="q2Resp('é‚„å¯ä»¥')">é‚„å¯ä»¥</button>
              <button class="btn-game" onclick="q2Resp('é‚„è¡Œ')">é‚„è¡Œ</button>
              <button class="btn-game" onclick="q2Resp('æˆ‘æ„›ä½ ')">æˆ‘æ„›ä½ </button>
            </div>
            <div id="q2-fb" class="mt-8 text-center italic gold-text min-h-[1.5rem] font-bold"></div>
          `;
        });
      }

      else if (idx === 3) {
        document.body.className = "style-storm";
        document.getElementById('storm-overlay').style.opacity = "1";
        FX.rain(true);

        const stormInterval = setInterval(() => {
          if(document.body.className !== "style-storm") clearInterval(stormInterval);
          else if(Math.random() > 0.7) FX.lightning();
        }, 2000);

        typewriter('quest-stage', ["ä»»å‹™ 3ï¼šé¢¨æš´ä¹‹åœ°", "é¢¨å‘è®Šå¾—æ··äº‚ï¼Œæµ·é¢é–‹å§‹ä¸å®‰åœ°èµ·ä¼ã€‚", "å¦³ä¾†åˆ°äº†ä¸€ç‰‡æ°£æ°›ç·Šç¹ƒçš„æœªçŸ¥åœ°å¸¶ã€‚å¦³æœƒé¸æ“‡â€”â€”"], 35, () => {
          stage.innerHTML += `
            <div class="flex flex-col gap-4 mt-8">
              <button class="btn-game q3-choice" onclick="q3Pick('å†·æˆ°', this)">å†·æˆ°</button>
              <button class="btn-game q3-choice" onclick="q3Pick('å¤§è²å’†å˜¯', this)">å¤§è²å’†å˜¯</button>
              <button class="btn-game q3-choice" onclick="q3Pick('ç›´æ¥é–‹æ‰', this)">ç›´æ¥é–‹æ‰</button>
            </div>
            <div id="q3-confirm" class="mt-8 text-center"></div>
          `;
        });
      }

      else if (idx === 4) {
        typewriter('quest-stage', ["ä»»å‹™ 4ï¼šæ·±æµ·ä¹‹ä¸‹", "æµ·é¢ç¸½æ˜¯çœ‹èµ·ä¾†å¹³éœï¼Œå»æ²’äººçœŸæ­£çŸ¥é“æ·±æµ·ä¸‹è—è‘—ä»€éº¼ã€‚", "è‹¥æƒ³çœŸæ­£ç†è§£é€™ç‰‡æµ·ï¼Œå¦³è¦ºå¾—æœ€éœ€è¦çš„æ˜¯ï¼Ÿ"], 35, () => {
          stage.innerHTML += `
            <div class="grid grid-cols-2 gap-4 mt-10">
              <label class="btn-game flex items-center justify-center gap-3"><input type="checkbox" value="å‹‡æ°£"> å‹‡æ°£</label>
              <label class="btn-game flex items-center justify-center gap-3"><input type="checkbox" value="è€å¿ƒ"> è€å¿ƒ</label>
              <label class="btn-game flex items-center justify-center gap-3"><input type="checkbox" value="å¥½å¥‡å¿ƒ"> å¥½å¥‡å¿ƒ</label>
              <label class="btn-game flex items-center justify-center gap-3"><input type="checkbox" value="æº«æŸ”"> æº«æŸ”</label>
            </div>
            <button class="btn-game w-full mt-12" onclick="q4Done()">æ²‰å…¥æ·±æµ·...</button>
          `;
        });
      }
    }

    function pickFood(name, el) {
      state.chosenDessert = name;
      document.querySelectorAll('.dessert-card').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      document.getElementById('q1-fb').innerHTML = `
        <div class="animate-bounce mt-4">
          <p>ä½ é¸æ“‡äº†ã€Œ${name}ã€ä½œç‚ºå†’éšªè£œçµ¦ã€‚</p>
          <p class="text-[var(--pink-purple)]">å–µï¼šé€™å€‹å¥½ï¼æˆ‘ä¹Ÿæƒ³åƒä¸€å£ã€‚</p>
        </div>
        <button class="btn-game mt-8 w-full" onclick="runQuest(2)">ä¸‹ä¸€å€‹ä»»å‹™</button>
      `;
    }

    function q2Resp(v) {
      const fb = document.getElementById('q2-fb');
      if (v === 'æˆ‘æ„›ä½ ') {
        fb.innerText = "â€¦â€¦ å°ã€‚ å°±æ˜¯é€™å€‹ã€‚";
        setTimeout(() => runQuest(3), 1500);
      } else {
        const ms = {
          'é‚„å¥½': "çœŸçš„é‚„å¥½ã€‚ä½†é‚„å¥½ä¸æ˜¯é€™å€‹ã€‚",
          'é‚„å¯ä»¥': "æˆ‘çŸ¥é“é‚„å¯ä»¥ï¼Œä½†é‚„å¯ä»¥é¸åˆ¥çš„ã€‚",
          'é‚„è¡Œ': "é‚„è¡Œï¼Œä½†å¥½åƒé‚„æ˜¯ä¸è¡Œã€‚"
        };
        fb.innerText = ms[v];
        setTimeout(() => fb.innerText = "", 2000);
      }
    }

    /* âœ… ä¿®æ­£ï¼šé¸é …æœƒåœç•™åç™½ï¼ˆselectedï¼‰ */
    function q3Pick(choice, el) {
      state.q3Choice = choice;

      // æ¸…é™¤å…¶ä»–é¸é …åç™½
      document.querySelectorAll('.q3-choice').forEach(b => b.classList.remove('selected'));
      // ç›®å‰é¸é …åç™½
      if (el) el.classList.add('selected');

      const box = document.getElementById('q3-confirm');
      if (!box) return;
      box.innerHTML = `
        <div class="gold-text font-bold mb-4">ä½ é¸æ“‡äº†ã€Œ${choice}ã€</div>
        <button class="btn-game w-full" onclick="q3Confirm()">ç¢ºå®šï¼Ÿ</button>
      `;
    }

    function q3Confirm() {
      document.body.className = "style-calm";
      document.getElementById('storm-overlay').style.opacity = "0";
      FX.clear();

      const stage = document.getElementById('quest-stage');
      stage.innerHTML = "";

      typewriter('quest-stage', [
        `ä½ åšå‡ºäº†é¸æ“‡ï¼šã€Œ${state.q3Choice}ã€ã€‚`,
        "åœ¨ä»»ä½•æ—…ç¨‹ä¸­ï¼Œè¡çªèˆ‡é¢¨æµªéƒ½ç„¡æ³•é¿å…ã€‚",
        "æœ‰æ™‚å€™æœƒæ²‰é»˜ï¼Œç”šè‡³æœƒèªªå‡ºä¸é‚£éº¼æº«æŸ”çš„è©±ã€‚",
        "ä½†æœ€çµ‚ï¼Œæˆ‘å€‘éƒ½æœƒèµ°å›å½¼æ­¤èº«é‚Šã€‚"
      ], 40, () => {
        stage.innerHTML += `<button class="btn-game mt-10 w-full" onclick="runQuest(4)">ä¸‹ä¸€å€‹ä»»å‹™</button>`;
      });
    }

    function q4Done() {
      const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
      const valStr = checked.length > 0 ? `ä½†è¨˜å¾—å¦³èªªéï¼Œå¦³æœƒç”¨${checked.join('ã€')}ä¾†æ¢ç´¢ã€‚` : "";

      const stage = document.getElementById('quest-stage');
      stage.innerHTML = "";
      typewriter('quest-stage', [
        "é è¿‘ä¸€ç‰‡æµ·ï¼Œå¾ä¾†éƒ½ä¸æ˜¯ç°¡å–®çš„äº‹ã€‚",
        "ä½†åªè¦é¡˜æ„ç†è§£â€”â€”é‚£ç‰‡æµ·ï¼Œçµ‚ç©¶æœƒç‚ºå¦³è®Šå¾—é€æ˜ã€‚",
        valStr
      ], 40, () => {
        stage.innerHTML += `<button class="btn-game mt-10 w-full" onclick="nextScene('final')">å‰å¾€æµ·åŸŸæ ¸å¿ƒ</button>`;
      });
    }

    function checkFinal() {
      const ans = document.getElementById('final-ans').value;
      if (ans === "å¥‡ç¾" || ans === "å¥‡ç¾åšç‰©é¤¨") {
        nextScene(6);
        const script = [
          "æ­å–œä½ ï¼Œæ¢ç´¢å®Œé€™ç‰‡ç¥ç§˜æµ·åŸŸã€‚",
          "ä½†â€¦â€¦",
          "ä½ ä»¥ç‚ºä½ æ‰¾åˆ°äº†é€™ç‰‡æµ·ï¼Œå…¶å¯¦â€”â€”",
          "æˆ‘ä¹Ÿåœ¨äººæµ·ä¸­æ‰¾åˆ°äº†ä½ ã€‚",
          "",
          "å¦‚æœæœªä¾†ä¹Ÿæœ‰é¢¨æµªï¼Œæˆ‘æƒ³æŠŠæˆ‘çš„æ‰‹ï¼Œæ”¾åœ¨ä½ æ‰‹ä¸Šã€‚",
          "æ¢éšªé‚„æ²’çµæŸã€‚ä½ é¡˜æ„ç¹¼çºŒé™ªæˆ‘èˆªè¡Œå—ï¼Ÿ"
        ];
        typewriter('ending-narrative', script, 50, () => {
          document.getElementById('ending-ui').classList.remove('hidden');
        });
      } else {
        showToast("æµ·é¢èµ·äº†éœ§ï¼Œå†æƒ³ä¸€ä¸‹ã€‚");
      }
    }

    function handleWait() {
      const btn = document.getElementById('think-btn');
      btn.innerText = "â€¦â€¦";
      setTimeout(() => {
        btn.innerText = "æˆ‘é¡˜æ„";
        btn.classList.remove('underline', 'text-xs');
        btn.classList.add('btn-game', 'text-xl');
        btn.onclick = triggerEnding;
        showToast("å–µï¼šåˆ¥å†å‚²å¬Œäº†å•¦ ğŸ˜¼");
      }, 1500);
    }

    function triggerEnding() {
      nextScene('blessing');
      const lines = [`å°äº†ï¼Œé—œæ–¼ä½ é¸çš„é‚£ä»½è£œçµ¦å“â€”â€”`, `ä¸‹æ¬¡ï¼Œæˆ‘å¸¶ä½ å»åƒã€Œ${state.chosenDessert}ã€ã€‚`];
      typewriter('recall-area', lines, 50, () => {
        setTimeout(() => {
          document.getElementById('recall-area').classList.add('hidden');
          document.getElementById('blessing-area').classList.remove('hidden');
          document.body.className = "style-dawn";
          FX.goldDust();
        }, 3000);
      });
    }

    function showToast(msg) {
      const t = document.getElementById('toast-msg');
      t.innerText = msg; t.style.opacity = "1"; t.style.top = "15%";
      setTimeout(() => { t.style.opacity = "0"; t.style.top = "20%"; }, 3000);
    }

    window.onload = () => {
      const title = document.getElementById('final-title');
      let timer;
      title.onmousedown = () => timer = setTimeout(() => showToast("å…¶å¯¦æˆ‘ç·´ç¿’äº†å¾ˆå¤šæ¬¡ï¼Œæ‰æ•¢æŠŠé€™é çµ¦ä½ ã€‚"), 2000);
      title.onmouseup = () => clearTimeout(timer);
    };
  </script>
</body>
</html>
